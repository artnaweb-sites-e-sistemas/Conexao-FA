rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isProfessional() {
      return hasRole('professional');
    }

    function isClient() {
      return hasRole('client');
    }

    // Users Collection
    // Admin manages all. Users can read their own profile.
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin() || isProfessional()); 
      // Professional might need to read user data to see client name if normalized, 
      // but client data is usually in 'clients' collection. 
      // Allowing pro to read users is safer for collaboration context.
      
      allow write: if isAdmin(); // Only Admin creates/edits users
    }

    // Clients Collection
    // Linked to a User. Contains business logic (assignments).
    match /clients/{clientId} {
      allow read: if isAdmin() 
                  || (isProfessional() && request.auth.uid in resource.data.assignedProfessionalIds)
                  || (isAuthenticated() && resource.data.uid == request.auth.uid);
                  
      allow create, update, delete: if isAdmin();
    }

    // Documents Collection
    match /documents/{docId} {
      function clientIsAssignedToPro() {
        // Check if the document's client is assigned to the requesting professional
        let clientData = get(/databases/$(database)/documents/clients/$(request.resource.data.clientId)).data;
        return request.auth.uid in clientData.assignedProfessionalIds;
      }
      
      function existingClientIsAssignedToPro() {
         let clientData = get(/databases/$(database)/documents/clients/$(resource.data.clientId)).data;
         return request.auth.uid in clientData.assignedProfessionalIds;
      }

      allow read: if isAdmin() 
                  || (isAuthenticated() && resource.data.uploadedByUid == request.auth.uid)
                  || (isProfessional() && existingClientIsAssignedToPro());

      allow create: if isAuthenticated(); 
      // Validation should ideally check if clientId belongs to user or if pro is assigned.
      
      allow update: if isAdmin() || (isProfessional() && existingClientIsAssignedToPro());
      allow delete: if isAdmin();
    }
    
    // Audit Logs
    match /audit_logs/{logId} {
       allow read: if isAdmin();
       allow create: if isAuthenticated(); // Application writes logs
       allow update, delete: if false; // Append-only
    }
  }
}
